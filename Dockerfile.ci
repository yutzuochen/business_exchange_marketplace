# ğŸš€ BusinessExchange CI/CD Dockerfile
# å¤šéšæ®µæ§‹å»ºï¼Œå„ªåŒ–æ˜ åƒå¤§å°å’Œå®‰å…¨æ€§

# æ§‹å»ºéšæ®µ
FROM golang:1.22-alpine AS builder

# å®‰è£å¿…è¦çš„å·¥å…·
RUN apk add --no-cache git ca-certificates tzdata

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ go mod æ–‡ä»¶
COPY go.mod go.sum ./

# ä¸‹è¼‰ä¾è³´
RUN go mod download

# è¤‡è£½æºä»£ç¢¼
COPY . .

# æ§‹å»ºæ‡‰ç”¨ç¨‹å¼
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags="-w -s -extldflags '-static'" \
    -o server ./cmd/server

# æ¸¬è©¦éšæ®µ
FROM golang:1.22-alpine AS tester

WORKDIR /app

# è¤‡è£½ä¾è³´å’Œæºä»£ç¢¼
COPY go.mod go.sum ./
RUN go mod download
COPY . .

# é‹è¡Œæ¸¬è©¦
RUN go test -v -race -coverprofile=coverage.out ./...

# é‹è¡Œå®‰å…¨æƒæ
RUN go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
RUN gosec -fmt=json -out=security-report.json ./...

# ç”Ÿç”¢éšæ®µ
FROM gcr.io/distroless/base-debian12:latest

# å®‰è£ CA è­‰æ›¸å’Œæ™‚å€æ•¸æ“š
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½äºŒé€²åˆ¶æ–‡ä»¶
COPY --from=builder /app/server /app/server

# è¤‡è£½æ¨¡æ¿å’Œéœæ…‹æ–‡ä»¶
COPY --from=builder /app/templates /app/templates
COPY --from=builder /app/static /app/static

# å‰µå»ºå¿…è¦çš„ç›®éŒ„
RUN mkdir -p /app/uploads /app/logs

# è¨­ç½®é root ç”¨æˆ¶
USER 65534:65534

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD ["/app/server", "-health-check"] || exit 1

# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
ENTRYPOINT ["/app/server"]
