name: Simple CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: businessexchange-468413
  REGION: us-central1
  SERVICE_NAME: trade-company
  IMAGE_NAME: gcr.io/businessexchange-468413/trade-company

jobs:
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Configure Docker
        run: gcloud auth configure-docker
        
      - name: Debug Check files
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Directory contents ==="
          ls -la
          echo "=== Dockerfile.simple contents ==="
          cat Dockerfile.simple
          echo "=== Go mod files ==="
          cat go.mod
          echo "=== Server directory ==="
          ls -la cmd/server/
          
      - name: Build and push
        run: |
          echo "=== Starting Docker build with simple version ==="
          docker build -f Dockerfile.simple -t ${{ env.IMAGE_NAME }}:${{ github.sha }} . || {
            echo "=== Docker build failed ==="
            echo "=== Checking Docker daemon ==="
            docker info
            echo "=== Checking Docker version ==="
            docker version
            exit 1
          }
          echo "=== Docker build successful ==="
          
          echo "=== Building latest tag ==="
          docker build -f Dockerfile.simple -t ${{ env.IMAGE_NAME }}:latest .
          
          echo "=== Pushing images ==="
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:latest

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --set-env-vars "APP_ENV=production,APP_NAME=BusinessExchange"
            
      - name: Health check
        run: |
          sleep 30
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} --format="value(status.url)")
          echo "Service URL: $SERVICE_URL"
          curl -f "$SERVICE_URL/health" || exit 1
